---
/**
 * Narrative Ticker Component
 *
 * Renders two independent text overlays:
 * 1) Ambient floating logs (eventType=AMBIENT), shown at random times/positions.
 * 2) Tick lifecycle banner for births and deaths, centered and fading out in 5s.
 */
---

<narrative-ticker class="pointer-events-none fixed inset-0 z-20 block overflow-hidden">
  <div data-ambient-layer class="absolute inset-0"></div>
  <div data-lifecycle-layer class="absolute inset-0"></div>
</narrative-ticker>

<style>
  .ambient-log {
    animation-name: ambient-log-float, ambient-log-flicker;
    animation-duration: var(--ambient-duration), 1200ms;
    animation-delay: var(--ambient-delay), 0ms;
    animation-timing-function: cubic-bezier(0.25, 0.7, 0.2, 1), ease-in-out;
    animation-fill-mode: forwards, both;
    animation-iteration-count: 1, infinite;
    transform: translateX(-50%);
    will-change: transform, opacity, filter;
  }

  @keyframes ambient-log-float {
    0% {
      opacity: 0;
      filter: blur(1.6px);
      transform: translate(-50%, 0) scale(0.92) rotate(var(--ambient-rotate));
    }

    14% {
      opacity: 0.86;
      filter: blur(0);
    }

    78% {
      opacity: 0.72;
    }

    100% {
      opacity: 0;
      filter: blur(1px);
      transform: translate(calc(-50% + var(--ambient-drift-x)), var(--ambient-drift-y)) scale(1.05)
        rotate(calc(var(--ambient-rotate) + 4deg));
    }
  }

  @keyframes ambient-log-flicker {
    0% {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.62), 0 0 0 rgba(180, 255, 235, 0);
    }

    50% {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.75), 0 0 12px rgba(180, 255, 235, 0.28);
    }

    100% {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.65), 0 0 0 rgba(180, 255, 235, 0);
    }
  }

  .lifecycle-popup {
    animation-fill-mode: forwards;
    will-change: transform, opacity, filter;
    text-shadow: 0 2px 14px rgba(0, 0, 0, 0.35);
  }

  .lifecycle-popup-birth {
    animation: birth-popup-rise 5000ms cubic-bezier(0.16, 0.84, 0.18, 1) forwards;
  }

  .lifecycle-popup-death {
    animation: death-popup-fall 5000ms cubic-bezier(0.14, 0.8, 0.2, 1) forwards;
  }

  @keyframes birth-popup-rise {
    0% {
      opacity: 0;
      filter: blur(1.2px);
      transform: translate(-50%, 22px) scale(0.92);
    }

    12% {
      opacity: 0.96;
      filter: blur(0);
      transform: translate(-50%, 0) scale(1);
    }

    75% {
      opacity: 0.84;
    }

    100% {
      opacity: 0;
      filter: blur(1px);
      transform: translate(-50%, -26px) scale(1.02);
    }
  }

  @keyframes death-popup-fall {
    0% {
      opacity: 0;
      filter: blur(1.2px);
      transform: translate(-50%, -22px) scale(0.93);
    }

    14% {
      opacity: 0.95;
      filter: blur(0);
      transform: translate(-50%, 0) scale(1);
    }

    74% {
      opacity: 0.82;
    }

    100% {
      opacity: 0;
      filter: blur(1px);
      transform: translate(-50%, 24px) scale(1.02);
    }
  }
</style>

<script>
  import type { SimulationEvent } from '../env.d.ts';

  const AMBIENT_MIN_INTERVAL_MS = 1800;
  const AMBIENT_MAX_INTERVAL_MS = 5200;
  const AMBIENT_MIN_DURATION_MS = 4200;
  const AMBIENT_MAX_DURATION_MS = 7000;
  const MAX_AMBIENT_QUEUE_SIZE = 18;
  const MAX_EVENT_MEMORY = 250;
  const LIFECYCLE_POPUP_DURATION_MS = 5000;

  function randomBetween(min: number, max: number): number {
    return Math.random() * (max - min) + min;
  }

  function buildEventKey(event: SimulationEvent): string {
    const idPart = event.id ?? 'no-id';
    return `${idPart}|${event.tick}|${event.timestamp}|${event.eventType}|${event.description}`;
  }

  class NarrativeTicker extends HTMLElement {
    private ambientLayer: HTMLElement | null = null;
    private lifecycleLayer: HTMLElement | null = null;

    private ambientQueue: SimulationEvent[] = [];
    private seenEventKeys: string[] = [];
    private seenEventKeySet = new Set<string>();

    private ambientSpawnTimer: ReturnType<typeof setTimeout> | null = null;
    private lastLifecycleTick: number | null = null;

    connectedCallback() {
      this.ambientLayer = this.querySelector('[data-ambient-layer]');
      this.lifecycleLayer = this.querySelector('[data-lifecycle-layer]');
    }

    disconnectedCallback() {
      this.clearAmbientSpawnTimer();
    }

    public updateNarrativeEvents(events: SimulationEvent[]) {
      this.queueAmbientEvents(events);
      this.updateLifecycleBanner(events);

      if (!this.ambientSpawnTimer && this.ambientQueue.length > 0) {
        this.scheduleNextAmbientSpawn();
      }
    }

    private queueAmbientEvents(events: SimulationEvent[]) {
      const ambientEvents = events
        .filter((event) => event.eventType === 'AMBIENT')
        .sort((a, b) => {
          if (a.tick !== b.tick) {
            return a.tick - b.tick;
          }
          return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
        });

      for (const event of ambientEvents) {
        const key = buildEventKey(event);
        if (this.seenEventKeySet.has(key)) {
          continue;
        }

        this.seenEventKeySet.add(key);
        this.seenEventKeys.push(key);
        this.ambientQueue.push(event);
      }

      if (this.ambientQueue.length > MAX_AMBIENT_QUEUE_SIZE) {
        this.ambientQueue = this.ambientQueue.slice(-MAX_AMBIENT_QUEUE_SIZE);
      }

      if (this.seenEventKeys.length > MAX_EVENT_MEMORY) {
        const keysToDrop = this.seenEventKeys.splice(0, this.seenEventKeys.length - MAX_EVENT_MEMORY);
        for (const key of keysToDrop) {
          this.seenEventKeySet.delete(key);
        }
      }
    }

    private scheduleNextAmbientSpawn() {
      this.clearAmbientSpawnTimer();

      if (this.ambientQueue.length === 0) {
        return;
      }

      const nextDelay = randomBetween(AMBIENT_MIN_INTERVAL_MS, AMBIENT_MAX_INTERVAL_MS);
      this.ambientSpawnTimer = setTimeout(() => {
        this.spawnAmbientLog();
        this.scheduleNextAmbientSpawn();
      }, nextDelay);
    }

    private spawnAmbientLog() {
      if (!this.ambientLayer || this.ambientQueue.length === 0) {
        return;
      }

      const event = this.ambientQueue.shift();
      if (!event) {
        return;
      }

      const logElement = document.createElement('p');
      const randomLeft = randomBetween(8, 92);
      const randomTop = randomBetween(14, 82);
      const driftX = randomBetween(-40, 40);
      const driftY = randomBetween(-100, -54);
      const rotate = randomBetween(-6, 6);
      const duration = randomBetween(AMBIENT_MIN_DURATION_MS, AMBIENT_MAX_DURATION_MS);
      const delay = randomBetween(0, 260);

      logElement.className =
        'ambient-log absolute max-w-[76vw] sm:max-w-[44vw] px-3 text-center text-xs sm:text-sm italic font-light tracking-[0.02em] leading-relaxed text-cyan-50/85';
      logElement.textContent = event.description;
      logElement.style.left = `${randomLeft}%`;
      logElement.style.top = `${randomTop}%`;
      logElement.style.setProperty('--ambient-drift-x', `${driftX}px`);
      logElement.style.setProperty('--ambient-drift-y', `${driftY}px`);
      logElement.style.setProperty('--ambient-rotate', `${rotate}deg`);
      logElement.style.setProperty('--ambient-duration', `${Math.round(duration)}ms`);
      logElement.style.setProperty('--ambient-delay', `${Math.round(delay)}ms`);

      this.ambientLayer.appendChild(logElement);

      const removeAfterMs = Math.round(duration + delay + 500);
      window.setTimeout(() => {
        logElement.remove();
      }, removeAfterMs);
    }

    private updateLifecycleBanner(events: SimulationEvent[]) {
      if (events.length === 0) {
        return;
      }

      const latestTick = events.reduce((maxTick, event) => Math.max(maxTick, event.tick), 0);
      if (this.lastLifecycleTick === latestTick) {
        return;
      }

      this.lastLifecycleTick = latestTick;

      const latestTickEvents = events.filter((event) => event.tick === latestTick);
      const birthEvents = latestTickEvents.filter((event) => event.eventType === 'BIRTH');
      const deathEvents = latestTickEvents.filter((event) => event.eventType === 'DEATH');

      this.showLifecyclePopups(latestTick, birthEvents, deathEvents);
    }

    private showLifecyclePopups(tick: number, birthEvents: SimulationEvent[], deathEvents: SimulationEvent[]) {
      if (!this.lifecycleLayer) {
        return;
      }

      if (birthEvents.length > 0) {
        this.spawnLifecyclePopup('birth', tick, birthEvents);
      }

      if (deathEvents.length > 0) {
        this.spawnLifecyclePopup('death', tick, deathEvents);
      }
    }

    private spawnLifecyclePopup(type: 'birth' | 'death', tick: number, events: SimulationEvent[]) {
      if (!this.lifecycleLayer) {
        return;
      }

      const popup = document.createElement('div');
      const count = events.length;
      const headlineLabel = type === 'birth' ? (count === 1 ? 'Birth' : 'Births') : (count === 1 ? 'Death' : 'Deaths');
      const narrative = events[Math.floor(randomBetween(0, events.length))]?.description ?? '';

      const baseY = type === 'birth' ? 42 : 57;
      const jitterX = randomBetween(-8, 8);
      const colorClasses = type === 'birth'
        ? 'text-emerald-100/95'
        : 'text-rose-100/95';
      const accentClasses = type === 'birth'
        ? 'text-emerald-200/70'
        : 'text-rose-200/70';
      const animationClass = type === 'birth'
        ? 'lifecycle-popup-birth'
        : 'lifecycle-popup-death';

      popup.className = `lifecycle-popup ${animationClass} absolute max-w-[88vw] sm:max-w-[42rem] text-center`;
      popup.style.left = `calc(50% + ${jitterX}px)`;
      popup.style.top = `${baseY}%`;

      const tickElement = document.createElement('div');
      tickElement.className = `text-[9px] font-mono uppercase tracking-[0.32em] ${accentClasses}`;
      tickElement.textContent = `Tick #${tick}`;

      const headlineElement = document.createElement('div');
      headlineElement.className = `mt-1 text-lg sm:text-xl font-light tracking-[0.08em] uppercase ${colorClasses}`;
      headlineElement.textContent = `${count} ${headlineLabel}`;

      const narrativeElement = document.createElement('div');
      narrativeElement.className = 'mt-1 text-xs sm:text-sm italic font-light tracking-[0.02em] text-white/78';
      narrativeElement.textContent = narrative;

      popup.appendChild(tickElement);
      popup.appendChild(headlineElement);
      popup.appendChild(narrativeElement);

      this.lifecycleLayer.appendChild(popup);

      window.setTimeout(() => {
        popup.remove();
      }, LIFECYCLE_POPUP_DURATION_MS + 300);
    }

    private clearAmbientSpawnTimer() {
      if (this.ambientSpawnTimer) {
        clearTimeout(this.ambientSpawnTimer);
        this.ambientSpawnTimer = null;
      }
    }
  }

  if (!customElements.get('narrative-ticker')) {
    customElements.define('narrative-ticker', NarrativeTicker);
  }
</script>
