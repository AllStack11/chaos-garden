---
/**
 * Statistics Panel Component
 * 
 * Refactored to use Custom Elements for reactive updates.
 */

import type { GardenState } from '../env.d.ts';

export interface Props {
  // Initial state is optional as it will be updated by the parent
  gardenState?: GardenState;
}

const { gardenState } = Astro.props;
---

<stats-panel>
  <div class="bg-white rounded-xl shadow-lg border border-garden-brown-200 overflow-hidden">
    <!-- Panel Header -->
    <div class="bg-gradient-to-r from-garden-green-600 to-garden-green-700 px-6 py-4">
      <h2 class="text-xl font-bold text-white flex items-center">
        <span class="mr-2">ðŸ“Š</span>
        Garden Census
      </h2>
      <p class="text-garden-green-100 text-sm mt-1" data-tick-info>
        {gardenState ? `Tick #${gardenState.tick}` : 'Waiting for connection...'}
      </p>
    </div>
    
    <!-- Stats Content -->
    <div class="p-6 space-y-6">
      <!-- Kingdom Populations -->
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-green-50 rounded-lg p-4 border border-green-100">
          <div class="text-green-800 text-sm font-medium">Plants</div>
          <div class="text-3xl font-bold text-green-900" id="stat-plants">
            {gardenState?.populationSummary.plants || 0}
          </div>
          <div class="mt-2 w-full bg-green-200 rounded-full h-1.5 overflow-hidden">
            <div 
              id="bar-plants"
              class="bg-green-600 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, (gardenState?.populationSummary.plants || 0) / 2)}%`}
            ></div>
          </div>
        </div>
        
        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-100">
          <div class="text-yellow-800 text-sm font-medium">Herbivores</div>
          <div class="text-3xl font-bold text-yellow-900" id="stat-herbivores">
            {gardenState?.populationSummary.herbivores || 0}
          </div>
          <div class="mt-2 w-full bg-yellow-200 rounded-full h-1.5 overflow-hidden">
            <div 
              id="bar-herbivores"
              class="bg-yellow-600 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, (gardenState?.populationSummary.herbivores || 0) / 1)}%`}
            ></div>
          </div>
        </div>
        
        <div class="bg-purple-50 rounded-lg p-4 border border-purple-100">
          <div class="text-purple-800 text-sm font-medium">Fungi</div>
          <div class="text-3xl font-bold text-purple-900" id="stat-fungi">
            {gardenState?.populationSummary.fungi || 0}
          </div>
          <div class="mt-2 w-full bg-purple-200 rounded-full h-1.5 overflow-hidden">
            <div 
              id="bar-fungi"
              class="bg-purple-600 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, (gardenState?.populationSummary.fungi || 0) / 1)}%`}
            ></div>
          </div>
        </div>
        
        <div class="bg-red-50 rounded-lg p-4 border border-red-100">
          <div class="text-red-800 text-sm font-medium">Carnivores</div>
          <div class="text-3xl font-bold text-red-900" id="stat-carnivores">
            {gardenState?.populationSummary.carnivores || 0}
          </div>
          <div class="mt-2 w-full bg-red-200 rounded-full h-1.5 overflow-hidden">
            <div 
              id="bar-carnivores"
              class="bg-red-600 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, (gardenState?.populationSummary.carnivores || 0) / 1)}%`}
            ></div>
          </div>
        </div>
      </div>
      
      <!-- Living vs Fallen -->
      <div class="space-y-4">
        <div>
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm font-medium text-garden-brown-700">Breath of the World (Living)</span>
            <span class="text-sm font-bold text-garden-green-700" id="stat-living">
              {gardenState?.populationSummary.totalLiving || 0}
            </span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
            <div 
              id="bar-living"
              class="bg-garden-green-500 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, ((gardenState?.populationSummary.totalLiving || 0) / (gardenState?.populationSummary.total || 1)) * 100)}%`}
            ></div>
          </div>
        </div>
        
        <div>
          <div class="flex justify-between items-center mb-1">
            <span class="text-sm font-medium text-garden-brown-700">Memory of the Garden (Fallen)</span>
            <span class="text-sm font-bold text-garden-brown-700" id="stat-fallen">
              {gardenState?.populationSummary.totalDead || 0}
            </span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
            <div 
              id="bar-fallen"
              class="bg-garden-brown-400 h-full transition-all duration-500" 
              style={`width: ${Math.min(100, ((gardenState?.populationSummary.totalDead || 0) / (gardenState?.populationSummary.total || 1)) * 100)}%`}
            ></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer info -->
    <div class="bg-gray-50 px-6 py-3 border-t border-garden-brown-100">
      <p class="text-xs text-garden-brown-500 text-center" data-footer-info>
        Total Entities Tracked: {gardenState?.populationSummary.total || 0}
      </p>
    </div>
  </div>
</stats-panel>

<script>
  import type { GardenState } from '../env.d.ts';

  class StatsPanel extends HTMLElement {
    constructor() {
      super();
    }

    public updateState(gardenState: GardenState) {
      if (!gardenState) return;
      const summary = gardenState.populationSummary;
      
      // Update text values
      this.updateText('stat-plants', summary.plants);
      this.updateText('stat-herbivores', summary.herbivores);
      this.updateText('stat-fungi', summary.fungi);
      this.updateText('stat-carnivores', summary.carnivores);
      this.updateText('stat-living', summary.totalLiving);
      this.updateText('stat-fallen', summary.totalDead);
      
      const tickInfo = this.querySelector('[data-tick-info]');
      if (tickInfo) tickInfo.textContent = `Tick #${gardenState.tick}`;

      const footerInfo = this.querySelector('[data-footer-info]');
      if (footerInfo) footerInfo.textContent = `Total Entities Tracked: ${summary.total}`;

      // Update bars
      this.updateBar('bar-plants', summary.plants, 200);
      this.updateBar('bar-herbivores', summary.herbivores, 100);
      this.updateBar('bar-fungi', summary.fungi, 100);
      this.updateBar('bar-carnivores', summary.carnivores, 100);
      this.updateBar('bar-living', summary.totalLiving, summary.total);
      this.updateBar('bar-fallen', summary.totalDead, summary.total);
    }

    private updateText(id: string, value: number) {
      const el = this.querySelector(`#${id}`);
      if (el) el.textContent = value.toLocaleString();
    }

    private updateBar(id: string, value: number, max: number) {
      const el = this.querySelector(`#${id}`) as HTMLElement;
      if (el) {
        const percent = Math.round((value / (max || 1)) * 100);
        el.style.width = `${Math.min(100, percent)}%`;
      }
    }
  }

  customElements.define('stats-panel', StatsPanel);
</script>
