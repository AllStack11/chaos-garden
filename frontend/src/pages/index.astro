---
/**
 * Main Garden Page
 * 
 * Optimized with Custom Elements for robust state management.
 */

import Layout from '../layouts/Layout.astro';
import GardenCanvas from '../components/GardenCanvas.astro';
import StatsPanel from '../components/StatsPanel.astro';

// API URL (will be overridden by environment variable)
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';
---

<Layout title="Chaos Garden üåø">
  <garden-app data-api-url={API_URL}>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-garden-green-900">
          Welcome to Your Chaos Garden
        </h1>
        <p class="mt-2 text-garden-brown-600">
          A living digital ecosystem that evolves every 15 minutes. 
          Watch as plants grow, herbivores roam, and life emerges from simple rules.
        </p>
      </div>
      
      <!-- Loading State -->
      <div data-loading class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex items-center">
          <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-yellow-600 mr-3"></div>
          <div>
            <p class="font-medium text-yellow-800">Loading garden data...</p>
            <p class="text-sm text-yellow-700">Connecting to simulation engine</p>
          </div>
        </div>
      </div>
      
      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Canvas and Controls -->
        <div class="lg:col-span-2 space-y-6">
          <div class="bg-white rounded-xl shadow-lg border border-garden-brown-200 p-4">
            <GardenCanvas width={800} height={600} />
          </div>

          <!-- Selection Info -->
          <div data-selection-info class="hidden mt-4 p-6 bg-white rounded-xl shadow-lg border border-garden-brown-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <div data-selection-icon class="w-12 h-12 rounded-full flex items-center justify-center mr-4">
                  <span class="text-2xl"></span>
                </div>
                <div>
                  <div data-selection-name class="text-xl font-bold text-garden-green-900"></div>
                  <div data-selection-stats class="text-garden-brown-600"></div>
                </div>
              </div>
              <button class="px-4 py-2 text-sm font-medium text-garden-brown-600 hover:text-garden-brown-900 hover:bg-garden-brown-50 rounded-lg transition-colors" data-clear-selection>
                Clear Selection
              </button>
            </div>
          </div>
        </div>
        
        <!-- Right Column: Stats and Info -->
        <div class="space-y-6">
          <StatsPanel />
          
          <!-- System Status -->
          <div class="bg-white rounded-xl shadow-lg border border-garden-brown-200 p-6">
            <h2 class="text-xl font-bold text-garden-green-900 mb-4 flex items-center">
              <span class="mr-2">‚öôÔ∏è</span>
              System Status
            </h2>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg transition-colors duration-500" id="system-status-container">
                <div class="flex items-center">
                  <div id="system-status-dot" class="w-3 h-3 rounded-full bg-gray-400 mr-3"></div>
                  <div>
                    <div id="system-status-title" class="font-medium text-gray-900">Connecting...</div>
                    <div id="system-status-subtitle" class="text-sm text-gray-600">Checking API health</div>
                  </div>
                </div>
                <span id="system-status-label" class="text-gray-500 font-medium">Pending</span>
              </div>
              
              <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                <div class="text-sm text-blue-700 font-medium mb-1">Time Until Next Tick</div>
                <div id="next-tick-countdown" class="text-2xl font-mono font-bold text-blue-900">
                  --:--
                </div>
                <div class="text-xs text-blue-600 mt-1" id="last-tick-time">
                  Waiting for data...
                </div>
              </div>

              <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="text-sm text-gray-700 font-medium mb-1">Last Data Fetch</div>
                <div data-last-update class="text-lg font-bold text-gray-900">
                  --:--:--
                </div>
                <div class="text-xs text-gray-600 mt-1">Auto-refresh: 30s</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </garden-app>
</Layout>

<script>
  import type { GardenState, Entity, SimulationEvent, HealthStatus } from '../env.d.ts';
  import { GardenService } from '../services/garden-service';

  class GardenApp extends HTMLElement {
    private gardenService: GardenService;
    private refreshInterval = 30000;
    private healthInterval = 10000;
    private countdownTimer: number | null = null;
    
    private state: {
      gardenState: GardenState | null;
      entities: Entity[];
      selectedEntity: Entity | null;
      recentEvents: SimulationEvent[];
      isLoading: boolean;
      health: HealthStatus | null;
      lastTickTime: Date | null;
    } = {
      gardenState: null,
      entities: [],
      selectedEntity: null,
      recentEvents: [],
      isLoading: true,
      health: null,
      lastTickTime: null
    };

    constructor() {
      super();
      const apiUrl = this.dataset.apiUrl || 'http://localhost:8787';
      this.gardenService = GardenService.getInstance(apiUrl);
      console.log('[GardenApp] Constructor initialized');
      this.setupEventListeners();
    }

    connectedCallback() {
      console.log('[GardenApp] Connected to DOM');
      // Trigger load immediately
      this.loadGardenData();
      this.checkHealth();
      
      setInterval(() => this.loadGardenData(), this.refreshInterval);
      setInterval(() => this.checkHealth(), this.healthInterval);
      
      // Start countdown timer (every second)
      this.countdownTimer = window.setInterval(() => this.updateCountdown(), 1000);
    }

    disconnectedCallback() {
      if (this.countdownTimer) clearInterval(this.countdownTimer);
    }

    private setupEventListeners() {
      this.addEventListener('entity-selected', (event: any) => {
        this.state.selectedEntity = event.detail;
        this.updateUI();
      });

      this.querySelector('[data-clear-selection]')?.addEventListener('click', () => {
        this.state.selectedEntity = null;
        this.updateUI();
      });
    }

    private async loadGardenData() {
      console.log('[GardenApp] loadGardenData starting');
      try {
        this.state.isLoading = true;
        this.updateUI();

        const data = await this.gardenService.fetchGardenData();

        if (data) {
          console.log('[GardenApp] Data received:', data);
          this.state.gardenState = data.gardenState;
          this.state.entities = data.entities;
          this.state.recentEvents = data.events;
          
          if (data.gardenState.timestamp) {
            const newTickTime = new Date(data.gardenState.timestamp);
            if (!this.state.lastTickTime || newTickTime > this.state.lastTickTime) {
              this.state.lastTickTime = newTickTime;
            }
          }
        } else {
          console.warn('[GardenApp] No data returned from service');
        }
      } catch (error) {
        console.error('[GardenApp] Failed to load garden:', error);
        this.showNotification('Failed to load garden data. Please try again.', 'error');
      } finally {
        this.state.isLoading = false;
        // Delay UI update to ensure Custom Elements are fully defined and connected
        setTimeout(() => this.updateUI(), 0);
        console.log('[GardenApp] loadGardenData finished');
      }
    }

    private updateUI() {
      // Update canvas
      const canvas = this.querySelector('garden-canvas') as any;
      if (canvas && typeof canvas.updateState === 'function') {
        canvas.updateState(this.state.entities, this.state.selectedEntity);
      } else if (canvas) {
        console.warn('[GardenApp] garden-canvas found but updateState is not yet available');
      }

      // Update Loading
      const loading = this.querySelector('[data-loading]') as HTMLElement;
      if (loading) loading.classList.toggle('hidden', !this.state.isLoading);

      // Update Selection Info
      const selectionInfo = this.querySelector('[data-selection-info]') as HTMLElement;
      if (selectionInfo) {
        selectionInfo.classList.toggle('hidden', !this.state.selectedEntity);
        if (this.state.selectedEntity) {
          const nameEl = this.querySelector('[data-selection-name]')!;
          const statsEl = this.querySelector('[data-selection-stats]')!;
          const iconEl = this.querySelector('[data-selection-icon]')!;
          
          nameEl.textContent = this.state.selectedEntity.species;
          statsEl.textContent = `Selected ‚Ä¢ Energy: ${Math.round(this.state.selectedEntity.energy)} ‚Ä¢ Age: ${this.state.selectedEntity.age} ticks`;
          iconEl.className = `w-12 h-12 rounded-full flex items-center justify-center mr-4 ${
            this.state.selectedEntity.type === 'plant' ? 'bg-green-100' : 'bg-yellow-100'
          }`;
          iconEl.querySelector('span')!.textContent = this.state.selectedEntity.type === 'plant' ? 'üåø' : 'ü¶å';
        }
      }

      // Update Stats Panel (via event or direct ref)
      const statsPanel = this.querySelector('stats-panel') as any;
      if (statsPanel && this.state.gardenState) {
        statsPanel.updateState(this.state.gardenState);
      }

      // Update Last Update Time
      const lastUpdate = this.querySelector('[data-last-update]') as HTMLElement;
      if (lastUpdate) lastUpdate.textContent = new Date().toLocaleTimeString();

      this.updateStatusUI();
    }

    private async checkHealth() {
      try {
        const health = await this.gardenService.checkHealth();
        this.state.health = health;
        if (health?.gardenState?.timestamp) {
           const newTickTime = new Date(health.gardenState.timestamp);
           if (!this.state.lastTickTime || newTickTime > this.state.lastTickTime) {
             this.state.lastTickTime = newTickTime;
           }
        }
      } catch (error) {
        console.error('[GardenApp] Health check failed:', error);
        this.state.health = { 
          status: 'unhealthy', 
          timestamp: new Date().toISOString(),
          gardenState: null,
          config: { tickIntervalMinutes: 15 }
        };
      } finally {
        this.updateStatusUI();
      }
    }

    private updateStatusUI() {
      const isHealthy = this.state.health?.status === 'healthy';
      
      // Update Header Status
      const headerStatus = document.getElementById('header-status');
      const headerDot = document.getElementById('header-status-dot');
      const headerText = document.getElementById('header-status-text');

      if (headerStatus && headerDot && headerText) {
        headerStatus.classList.remove('hidden');
        if (isHealthy) {
          headerStatus.className = 'sm:flex items-center space-x-2 px-3 py-1.5 bg-green-50 rounded-full transition-colors duration-500';
          headerDot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
          headerText.className = 'text-sm font-medium text-green-800';
          headerText.textContent = 'Live';
        } else {
          headerStatus.className = 'sm:flex items-center space-x-2 px-3 py-1.5 bg-red-50 rounded-full transition-colors duration-500';
          headerDot.className = 'w-2 h-2 rounded-full bg-red-500';
          headerText.className = 'text-sm font-medium text-red-800';
          headerText.textContent = 'Disconnected';
        }
      }

      // Update Sidebar Status
      const container = document.getElementById('system-status-container');
      const dot = document.getElementById('system-status-dot');
      const title = document.getElementById('system-status-title');
      const subtitle = document.getElementById('system-status-subtitle');
      const label = document.getElementById('system-status-label');

      if (container && dot && title && subtitle && label) {
        if (isHealthy) {
          container.className = 'flex items-center justify-between p-3 bg-green-50 rounded-lg transition-colors duration-500 border border-green-100';
          dot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse mr-3';
          title.textContent = 'Simulation';
          
          const currentTick = this.state.health?.gardenState?.tick ?? this.state.gardenState?.tick;
          subtitle.textContent = `Tick #${currentTick ?? '?'}`;
          
          label.className = 'text-green-700 font-medium';
          label.textContent = 'Active';
        } else {
          container.className = 'flex items-center justify-between p-3 bg-red-50 rounded-lg transition-colors duration-500 border border-red-100';
          dot.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
          title.textContent = 'API Offline';
          subtitle.textContent = 'Connection lost';
          label.className = 'text-red-700 font-medium';
          label.textContent = 'Error';
        }
      }

      // Update Last Tick Text
      const lastTickEl = document.getElementById('last-tick-time');
      if (lastTickEl && this.state.lastTickTime) {
        lastTickEl.textContent = `Last tick: ${this.state.lastTickTime.toLocaleTimeString()}`;
      }
    }

    private updateCountdown() {
      if (!this.state.lastTickTime) return;

      const countdownEl = document.getElementById('next-tick-countdown');
      if (!countdownEl) return;

      const intervalMs = (this.state.health?.config?.tickIntervalMinutes || 15) * 60 * 1000;
      const gracePeriodMs = 60000; // 1 minute grace period before showing "Evolving..."
      
      const now = new Date().getTime();
      const lastTickMs = this.state.lastTickTime.getTime();
      const nextTickMs = lastTickMs + intervalMs;
      
      let remainingMs = nextTickMs - now;
      
      if (remainingMs < -gracePeriodMs) {
        countdownEl.textContent = "Evolving...";
        countdownEl.classList.add('animate-pulse');
        return;
      }

      countdownEl.classList.remove('animate-pulse');

      if (remainingMs < 0) {
        countdownEl.textContent = "00:00";
        return;
      }
      
      const minutes = Math.floor(remainingMs / 60000);
      const seconds = Math.floor((remainingMs % 60000) / 1000);
      
      countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    private showNotification(message: string, type: 'success' | 'error' | 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg border transition-opacity duration-500 ${
        type === 'success' ? 'bg-green-50 border-green-200 text-green-800' :
        type === 'error' ? 'bg-red-50 border-red-200 text-red-800' :
        'bg-blue-50 border-blue-200 text-blue-800'
      }`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }
  }

  customElements.define('garden-app', GardenApp);
</script>
