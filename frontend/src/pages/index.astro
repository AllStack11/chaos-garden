---
/**
 * Main Garden Page
 * 
 * Optimized with Custom Elements for robust state management.
 */

import Layout from '../layouts/Layout.astro';
import GardenCanvas from '../components/GardenCanvas.astro';
import StatsPanel from '../components/StatsPanel.astro';
import WeatherPanel from '../components/WeatherPanel.astro';
import NarrativeTicker from '../components/NarrativeTicker.astro';
import JournalOverlay from '../components/JournalOverlay.astro';
import StatsOverlay from '../components/StatsOverlay.astro';

// API URL â€” required at build time
const API_URL = import.meta.env.PUBLIC_API_URL?.trim();
if (!API_URL) {
  throw new Error('Missing PUBLIC_API_URL. Set it in frontend/.env.production or your deploy environment before building.');
}
---

<Layout title="Chaos Garden ðŸŒ¿">
  <garden-app data-api-url={API_URL} class="block h-full w-full">
    <!-- Immersive Canvas -->
    <div class="absolute inset-0 z-0">
      <GardenCanvas />
    </div>

    <!-- UI Overlay Layer -->
    <div id="ui-overlay" class="pointer-events-none relative z-10 flex h-full w-full flex-col justify-between p-3 sm:p-4 md:p-8 transition-opacity duration-1000">
      
      <!-- Top Subtle Info -->
      <div class="flex items-start justify-between gap-4">
        <div class="group pointer-events-auto">
          <button
            type="button"
            data-journal-toggle
            class="flex flex-col opacity-50 transition-opacity hover:opacity-100 drop-shadow-sm text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-garden-green-300/80 focus-visible:ring-offset-2 focus-visible:ring-offset-transparent rounded"
          >
            <h1 class="text-sm sm:text-base md:text-lg font-light tracking-[0.25em] sm:tracking-widest text-white uppercase">Chaos Garden</h1>
            <div id="system-status-container" class="mt-1 flex items-center space-x-2 text-[10px]">
              <div id="system-status-dot" class="h-1.5 w-1.5 rounded-full bg-white/40"></div>
              <span id="system-status-subtitle" class="font-mono text-white/60 tracking-tighter uppercase">Initializing...</span>
            </div>
          </button>
        </div>

        <div class="group pointer-events-auto">
          <div class="flex flex-col items-end opacity-50 transition-opacity hover:opacity-100 drop-shadow-sm">
             <div id="next-tick-countdown" class="font-mono text-lg sm:text-xl md:text-2xl font-light text-white tracking-widest">
                --:--
             </div>
             <div class="mt-1 text-[10px] text-white/40 uppercase tracking-[0.2em]">Next Evolution</div>
          </div>
        </div>
      </div>

      <!-- Center: Selection Tooltip (Floating Contextual) -->
      <div data-selection-info class="hidden pointer-events-none absolute transition-all duration-300">
        <div class="pointer-events-auto flex translate-y-0 sm:translate-y-8 flex-col items-center space-y-2 sm:space-y-3 rounded-2xl bg-garden-green-900/20 px-4 sm:px-6 py-3 sm:py-4 backdrop-blur-md border border-garden-green-500/10 shadow-2xl min-w-[150px] sm:min-w-[180px]">
          <div class="flex items-center space-x-3 sm:space-x-4">
             <div data-selection-icon class="text-xl sm:text-2xl"></div>
             <div class="flex flex-col">
               <div data-selection-name class="text-sm font-medium text-white/90 tracking-tight"></div>
               <div data-selection-species class="text-[8px] sm:text-[9px] text-white/40 uppercase tracking-widest"></div>
             </div>
          </div>
          
          <!-- Vital Indicators -->
          <div class="w-full space-y-2 pt-1 border-t border-white/5">
            <!-- Health Bar -->
            <div class="space-y-1">
              <div class="flex justify-between text-[8px] font-mono text-white/30 uppercase tracking-tighter">
                <span>Vigor</span>
                <span data-selection-health-text>--%</span>
              </div>
              <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                <div data-selection-health-bar class="h-full bg-green-400 transition-all duration-500"></div>
              </div>
            </div>
            <!-- Energy Bar -->
            <div class="space-y-1">
              <div class="flex justify-between text-[8px] font-mono text-white/30 uppercase tracking-tighter">
                <span>Essence</span>
                <span data-selection-energy-text>--%</span>
              </div>
              <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                <div data-selection-energy-bar class="h-full bg-yellow-400 transition-all duration-500"></div>
              </div>
            </div>
          </div>

          <div data-selection-stats class="text-[8px] sm:text-[9px] text-white/30 font-mono text-center pt-1"></div>
        </div>
      </div>

      <!-- Bottom: Environment Stats -->
      <div class="hidden sm:flex items-end justify-between">
        <div class="pointer-events-auto drop-shadow-sm">
          <StatsPanel />
        </div>
        
        <div class="flex flex-col items-end space-y-4">
           <div class="drop-shadow-sm">
             <WeatherPanel />
           </div>

        </div>
      </div>
    </div>

    <!-- Narrative overlays remain visible even when UI overlay fades -->
    <NarrativeTicker />
    <JournalOverlay />
    <StatsOverlay apiUrl={API_URL} />

    <!-- Loading State (Minimal Ambient) -->
    <div data-loading class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm transition-opacity duration-1000">
      <div class="flex flex-col items-center space-y-4">
        <div class="h-12 w-12 animate-spin rounded-full border-t-2 border-white/20"></div>
        <div class="text-xs font-light tracking-[0.3em] text-white/40 uppercase">Connecting...</div>
      </div>
    </div>
  </garden-app>
</Layout>

<script>
  import { registerGardenApp } from '../components/garden-app';
  registerGardenApp();
</script>
